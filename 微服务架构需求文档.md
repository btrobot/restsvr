# 微服务基础架构需求文档

## 项目目标
创建一个开箱即用的 FastAPI 微服务开发模板，支持多服务并行开发，集成常用中间件，并区分测试/生产环境。

## 核心组件需求

### 1. 微服务层（3-4 个示例服务）
- **用户服务**：用户注册、登录、信息管理
- **订单服务**：订单创建、查询、状态管理
- **商品服务**：商品信息、库存管理
- **API 网关服务**：统一入口、路由转发、认证

### 2. 基础设施层
- **Nginx**：反向代理、负载均衡、静态文件服务
- **Redis**：缓存、Session 存储、消息队列
- **PostgreSQL**：主数据库（用户、订单等核心业务）
- **MySQL**：辅助数据库（日志、监控等）
- **SQLite**：单元测试和本地开发测试

### 3. 环境配置
- **开发环境**：
  - 热重载支持
  - 详细日志
  - SQLite 测试
  - 本地调试工具

- **测试环境**：
  - 自动化测试
  - 测试数据库隔离
  - Mock 外部服务

- **生产环境**：
  - Gunicorn + Uvicorn 运行
  - 多进程/多 worker
  - 日志收集
  - 性能监控

### 4. 开发工具
- 代码热重载
- 自动重启
- 日志实时查看
- 数据库迁移工具
- API 文档自动生成

### 5. 目录结构设计
```
.
├── docker-compose.yml          # 生产环境编排
├── docker-compose.dev.yml      # 开发环境编排
├── docker-compose.test.yml     # 测试环境编排
├── nginx/
│   ├── Dockerfile
│   └── nginx.conf              # 路由配置
├── redis/
│   └── redis.conf
├── services/
│   ├── user-service/
│   │   ├── app/
│   │   │   ├── main.py
│   │   │   ├── models/
│   │   │   ├── routers/
│   │   │   ├── schemas/
│   │   │   └── core/
│   │   ├── tests/
│   │   ├── Dockerfile
│   │   ├── requirements.txt
│   │   └── .env.example
│   ├── order-service/          # 类似结构
│   └── product-service/        # 类似结构
└── common/
    ├── database/
    ├── utils/
    └── middleware/
```

## 功能特性

### 必需功能
- [ ] 服务间通信（HTTP + 异步消息）
- [ ] 统一的配置管理
- [ ] 健康检查接口
- [ ] 日志聚合
- [ ] 自动 API 文档（Swagger）
- [ ] 数据库迁移
- [ ] CORS 支持
- [ ] 异常处理

### 可选功能
- [ ] JWT 认证
- [ ] 限流和熔断
- [ ] 链路追踪（OpenTelemetry）
- [ ] 监控面板（Prometheus + Grafana）

## 技术栈
- **后端**：FastAPI + Pydantic + SQLAlchemy
- **数据库**：PostgreSQL（主）+ MySQL（辅）+ SQLite（测试）
- **缓存**：Redis
- **网关**：Nginx
- **容器化**：Docker + Docker Compose
- **WSGI 服务器**：Gunicorn + Uvicorn
- **测试**：pytest + pytest-asyncio
